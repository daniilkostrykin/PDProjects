# Руководство по настройке проекта AutoPass

Это руководство содержит подробные инструкции по настройке и запуску проекта AutoPass, который представляет собой полнофункциональное приложение для управления пропусками с аутентификацией и авторизацией сотрудников.

## Обзор проекта

Проект AutoPass состоит из:
- **Бэкенд**: приложение Spring Boot с аутентификацией JWT и базой данных PostgreSQL
- **Фронтенд**: приложение React с использованием Vite в качестве инструмента сборки
- **База данных**: PostgreSQL для хранения пользовательских данных, пропусков и журналов доступа

## Предварительные требования

Перед настройкой проекта убедитесь, что на вашей системе установлено следующее:

1. **Docker и Docker Compose** (для контейнеризованной настройки)
2. **Java 21** (для локальной разработки бэкенда)
3. **Node.js 18+** (для локальной разработки фронтенда)
4. **Maven** (для сборки бэкенда)
5. **Git** (для клонирования репозитория)

## Конфигурация окружения

Проект использует переменные окружения для конфигурации. Создайте файл `.env` в корневом каталоге с следующими переменными:

```env
# Конфигурация базы данных
POSTGRES_USER=autopass
POSTGRES_PASSWORD=autopass
POSTGRES_DB=autopass
DB_PORT=5449

# Конфигурация бэкенда
BACKEND_PORT=8080

# Конфигурация фронтенда
FRONTEND_DEV_PORT=5173
VITE_API_URL=http://localhost:8080/api

# Теги Docker-образов
BRANCH=local
```

## Методы настройки

Проект можно запустить двумя способами: с использованием Docker Compose или запуском служб локально. Оба метода автоматизированы через задачи VSCode.

### Метод 1: Настройка Docker Compose (Рекомендуется)

Этот метод запускает все службы в Docker-контейнерах и рекомендуется для обеспечения согласованности в разных средах.

#### Использование задач VSCode

1. Откройте проект в VSCode
2. Нажмите `Ctrl+Shift+P`, чтобы открыть палитру команд
3. Введите "Tasks: Run Task" и выберите эту опцию
4. Выберите одну из следующих задач:

**Запуск всего приложения в Docker:**
- Задача: `Start All In Docker`
- Это создает и запускает все службы (фронтенд, бэкенд, база данных) в Docker-контейнерах

**Запуск только базы данных:**
- Задача: `Start DB (docker-compose)`
- Запускает только базу данных PostgreSQL в Docker-контейнере

**Остановка всех Docker-сервисов:**
- Задача: `Stop All Docker`
- Останавливает все запущенные Docker-контейнеры

#### Ручные команды Docker

В качестве альтернативы, вы можете использовать Docker Compose непосредственно из командной строки:

```bash
# Запуск всех служб в фоновом режиме
docker-compose up --build -d

# Просмотр логов
docker-compose logs -f

# Остановка всех служб
docker-compose down

# Запуск только базы данных
docker-compose up -d db
```

### Метод 2: Настройка локальной разработки

Этот метод запускает бэкенд и фронтенд локально, а для базы данных использует Docker. Это идеально подходит для активной разработки, поскольку обеспечивает более быстрые циклы итерации.

#### Использование задач VSCode

1. Откройте проект в VSCode
2. Нажмите `Ctrl+Shift+P`, чтобы открыть палитру команд
3. Введите "Tasks: Run Task" и выберите эту опцию
4. Выберите из следующих задач:

**Запуск полной среды разработки:**
- Задача: `Start All Dev Servers`
- Запускает базу данных в Docker, собирает и запускает бэкенд локально, а также запускает сервер разработки фронтенда

**Запуск отдельных служб:**
- `Start DB (docker-compose)`: запуск только базы данных в Docker
- `Start Backend (local)`: запуск бэкенда локально (требует предварительной сборки)
- `Start Frontend (local)`: запуск сервера разработки фронтенда

**Остановка серверов разработки:**
- Задача: `Stop All Dev Servers`
- Останавливает все локально запущенные службы

#### Ручная локальная настройка

**Настройка бэкенда:**
1. Перейдите в каталог `backend`
2. Соберите проект: `mvn clean install`
3. Запустите приложение: `mvn spring-boot:run`

**Настройка фронтенда:**
1. Перейдите в каталог `frontend`
2. Установите зависимости: `npm install`
3. Запустите сервер разработки: `npm run dev`

## Автоматизация задач VSCode

Проект включает несколько задач VSCode, определенных в файле `.vscode/tasks.json` для общих операций:

### Доступные задачи

1. **Start DB (docker-compose)**
   - Запускает только базу данных PostgreSQL в Docker-контейнере
   - Команда: `docker-compose up -d db`

2. **Start Backend (local)**
   - Запускает приложение бэкенда локально
   - Команда: `java -jar target/AutoPass-0.0.1-SNAPSHOT.jar`
   - Требует предварительной сборки проекта с помощью `mvn clean install`

3. **Start Frontend (local)**
   - Запускает сервер разработки фронтенда
   - Команда: `npm run dev`
   - По умолчанию запускается на порту 5173

4. **Start All Dev Servers**
   - Последовательно запускает DB, Backend и Frontend
   - Использует свойства `dependsOn` и `dependsOrder` для обеспечения правильного порядка запуска

5. **Start All In Docker**
   - Собирает и запускает все службы в Docker-контейнерах
   - Команда: `docker-compose up --build`

6. **Stop All Docker**
   - Останавливает все запущенные Docker-контейнеры
   - Команда: `docker-compose down`

7. **Stop Backend (local)**
   - Останавливает локально запущенный процесс бэкенда на порту 8080
   - Использует команду PowerShell для завершения процесса

8. **Stop Frontend (local)**
   - Останавливает локально запущенный процесс фронтенда на порту 5173
   - Использует команду PowerShell для завершения процесса

9. **Stop All Dev Servers**
   - Останавливает службы фронтенда, бэкенда и Docker

### Зависимости задач

Задачи VSCode спроектированы с зависимостями для обеспечения правильного порядка запуска:
- `Start All Dev Servers` зависит от запуска DB, затем Backend, затем Frontend по порядку
- `Stop All Dev Servers` останавливает службы в обратном порядке для предотвращения ошибок

## Конфигурация Docker Compose

Проект использует два файла Docker Compose:

### docker-compose.yml (настройка, похожая на продакшн)
- Определяет службы для фронтенда, бэкенда и базы данных
- Использует продакшн Dockerfile для сборки образов
- Настраивает пользовательскую сеть для связи служб

### docker-compose.override.yml (настройка разработки)
- Переопределяет настройки продакшна для разработки
- Использует `Dockerfile.dev` для фронтенда, чтобы включить горячую перезагрузку
- Открывает порты разработки
- Настраивает переменные окружения для разработки

## Рабочий процесс разработки

### Запуск в режиме разработки

Для активной разработки используйте подход локальной настройки:

1. Запустите базу данных: задача `Start DB (docker-compose)`
2. Соберите и запустите бэкенд локально: задача `Start Backend (local)`
3. Запустите фронтенд: задача `Start Frontend (local)`

Такая настройка позволяет:
- Быстро перезагружать изменения фронтенда
- Использовать Spring Boot devtools для изменений бэкенда
- Прямой доступ к логам и отладке

### Сборка для продакшна

Для сборки артефактов, готовых к продакшну:

**Бэкенд:**
```bash
cd backend
mvn clean install
```

**Фронтенд:**
```bash
cd frontend
npm install
npm run build
```

## Конфигурация базы данных

Проект использует PostgreSQL со следующей конфигурацией:
- Имя базы данных: `autopass`
- Имя пользователя: `autopass`
- Пароль: `autopass`
- Порт: `5449` (чтобы избежать конфликтов с портом PostgreSQL по умолчанию)

Скрипты инициализации базы данных находятся в каталоге `db-init/`:
- `init.sql`: начальная схема базы данных
- `02_add_core_tables.sql`: дополнительные определения таблиц

## Документация API

Документация API доступна в файле `API_DOCUMENTATION.md` в корне проекта.

## Устранение неполадок

### Распространенные проблемы

1. **Порт уже используется**: убедитесь, что никакие другие приложения не используют порты 8080, 5173 или 5449
2. **Ошибки разрешений Docker**: убедитесь, что Docker запущен соответствующими разрешениями
3. **Ошибки установки зависимостей**: проверьте подключение к сети и настройки прокси
4. **Проблемы с подключением к базе данных**: проверьте, что служба базы данных запущена и доступна

### Сброс среды

Для полного сброса среды разработки:

1. Остановите все службы: `Stop All Dev Servers` или `Stop All Docker`
2. Удалите Docker-контейнеры и тома: `docker-compose down -v`
3. Очистите кэш Maven: `mvn dependency:purge-local-repository`
4. Очистите кэш npm: `npm cache clean --force`
5. Перезапустите с желаемым методом настройки

## Дополнительные замечания

- Проект использует JWT для аутентификации с настраиваемым сроком действия токена
- CORS настроен для разрешения запросов с источника фронтенда
- Бэкенд использует Spring Security для аутентификации и авторизации
- Фронтенд использует React с Vite для быстрой разработки
- Схема базы данных управляется с помощью JPA с `ddl-auto=update` в разработке